<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IDX Trading Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              aerialSky: '#5BC3EB',
              aerialPurple: '#6F58E9',
              aerialLilac: '#C7C1FF',
              aerialGreen: '#7ED957',
              aerialSlate: '#EEF2FF',
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: 'Poppins', sans-serif;
      }
    </style>
  </head>
  <body class="min-h-screen bg-[#6B4AEC] text-slate-900">
    <div class="pt-4 text-white">
      <header class="mx-auto flex max-w-screen-lg flex-col items-center gap-10 lg:flex-row">
        <div class="flex-1 space-y-8">
          <span class="inline-flex w-fit rounded-full bg-white/10 px-4 py-1 text-sm font-semibold uppercase tracking-wider">Climate action</span>
          <h1 class="text-4xl font-bold leading-tight sm:text-5xl">Climate action, in your hands</h1>
          <p class="max-w-xl text-lg text-slate-100">
            Accurately offset your carbon footprint with IDX. Track your impact, learn from insights, and take action toward a cleaner future in just a tap.
          </p>
        </div>
        <div class="flex-1">
          <div class="">
            <img src="hero-banner-idx.png" alt="Eco island illustration" class="" />
          </div>
        </div>
      </header>

      <section class="mt-8 grid gap-12">
        <div class="bg-white p-8">
          <div class="flex flex-wrap items-center gap-1">
            <button data-tab="trading" class="tab-button rounded-full bg-aerialPurple px-6 py-2 text-sm font-semibold text-white shadow-lg shadow-aerialPurple/30 transition focus:outline-none focus:ring-2 focus:ring-aerialPurple">Tickers</button>
            <button data-tab="indicators" class="tab-button rounded-full bg-slate-100 px-6 py-2 text-sm font-semibold text-aerialPurple transition hover:bg-aerialLilac/40 focus:outline-none focus:ring-2 focus:ring-aerialPurple">Indicators</button>
            <div class="ml-4 flex flex-col gap-1 text-sm text-slate-200 sm:flex-row sm:items-center sm:justify-between">
            <span class="font-medium text-slate-800">Last updated: <span id="last-updated" class="font-normal text-slate-400">--</span></span>
          </div>
          </div>
          <div class="mt-6 flex flex-wrap gap-3 rounded-2xl bg-slate-50/80 p-4 text-sm text-slate-600">
            <div class="flex flex-col gap-1">
              <label for="ticker-filter" class="font-semibold text-slate-700">Ticker</label>
              <select id="ticker-filter" class="rounded-full border border-slate-200 px-4 py-2 text-sm text-slate-800 focus:border-aerialPurple focus:outline-none focus:ring-2 focus:ring-aerialPurple/30">
                <option value="all">All tickers</option>
              </select>
            </div>
            <div class="flex flex-col gap-1">
              <label for="date-filter" class="font-semibold text-slate-700">Trading date</label>
              <input type="date" id="date-filter" class="rounded-full border border-slate-200 px-4 py-2 text-sm text-slate-800 focus:border-aerialPurple focus:outline-none focus:ring-2 focus:ring-aerialPurple/30" />
            </div>
            <div class="ml-auto flex items-end">
              <button id="clear-filters" class="rounded-full bg-white px-4 py-2 font-semibold text-aerialPurple shadow-sm shadow-aerialPurple/20 transition hover:bg-aerialLilac/60 focus:outline-none focus:ring-2 focus:ring-aerialPurple/40">
                Reset filters
              </button>
            </div>
          </div>

          <div class="mt-4 overflow-x-auto">
            <div id="trading-loading" class="hidden rounded-xl bg-slate-100 px-4 py-3 text-sm text-slate-500">Loading historical dataâ€¦</div>
            <div id="trading-error" class="hidden rounded-xl bg-rose-100 px-4 py-3 text-sm text-rose-600"></div>
            <table data-panel="trading" class="tab-panel w-full min-w-[640px] table-auto border-separate border-spacing-y-2">
              <thead>
                <tr class="text-left text-xs uppercase tracking-wide text-slate-500">
                  <th class="rounded-l-xl bg-slate-50 px-4 py-3">Ticker</th>
                  <th class="bg-slate-50 px-4 py-3">Open</th>
                  <th class="bg-slate-50 px-4 py-3">High</th>
                  <th class="bg-slate-50 px-4 py-3">Close</th>
                  <th class="rounded-r-xl bg-slate-50 px-4 py-3">Volume</th>
                </tr>
              </thead>
              <tbody id="trading-table-body" class="text-sm text-slate-700"></tbody>
            </table>
            <div id="trading-empty-state" class="hidden rounded-xl bg-slate-100 px-4 py-6 text-center text-sm text-slate-500">
              No trades found for the selected filters.
            </div>
          </div>

            <table data-panel="indicators" class="tab-panel hidden w-full min-w-[960px] table-auto border-separate border-spacing-y-2">
              <thead>
                <tr class="text-left text-xs uppercase tracking-wide text-slate-500">
                  <th class="rounded-l-xl bg-slate-50 px-4 py-3">Ticker</th>
                  <th class="bg-slate-50 px-4 py-3">Close</th>
                  <th class="bg-slate-50 px-4 py-3">Volume</th>
                  <th class="bg-slate-50 px-4 py-3">MA20</th>
                  <th class="bg-slate-50 px-4 py-3">MA50</th>
                  <th class="bg-slate-50 px-4 py-3">RSI14</th>
                  <th class="bg-slate-50 px-4 py-3">Max30</th>
                  <th class="bg-slate-50 px-4 py-3">Max30 Date</th>
                  <th class="bg-slate-50 px-4 py-3">New30HighWithin5</th>
                  <th class="bg-slate-50 px-4 py-3">Pullback2DnStay&gt;MA20</th>
                  <th class="bg-slate-50 px-4 py-3">Bullish Reversal</th>
                  <th class="bg-slate-50 px-4 py-3">Vol Surge 130</th>
                  <th class="rounded-r-xl bg-slate-50 px-4 py-3">Indicator</th>
                </tr>
              </thead>
              <tbody class="text-sm text-slate-700">
                <tr class="bg-slate-100/70">
                  <td class="rounded-l-xl px-4 py-3 font-semibold text-slate-900">MSFT</td>
                  <td class="px-4 py-3">$412.22</td>
                  <td class="px-4 py-3">21.5M</td>
                  <td class="px-4 py-3">$405.80</td>
                  <td class="px-4 py-3">$390.10</td>
                  <td class="px-4 py-3 text-emerald-600">62</td>
                  <td class="px-4 py-3">$418.00</td>
                  <td class="px-4 py-3">Apr 09</td>
                  <td class="px-4 py-3">Yes</td>
                  <td class="px-4 py-3">No</td>
                  <td class="px-4 py-3">Emerging</td>
                  <td class="px-4 py-3 text-emerald-600">Yes</td>
                  <td class="rounded-r-xl px-4 py-3 font-medium text-aerialPurple">Momentum</td>
                </tr>
                <tr class="bg-slate-100/70">
                  <td class="rounded-l-xl px-4 py-3 font-semibold text-slate-900">NFLX</td>
                  <td class="px-4 py-3">$588.73</td>
                  <td class="px-4 py-3">8.9M</td>
                  <td class="px-4 py-3">$575.40</td>
                  <td class="px-4 py-3">$542.60</td>
                  <td class="px-4 py-3 text-amber-500">54</td>
                  <td class="px-4 py-3">$599.10</td>
                  <td class="px-4 py-3">Apr 22</td>
                  <td class="px-4 py-3">No</td>
                  <td class="px-4 py-3">Yes</td>
                  <td class="px-4 py-3">Confirmed</td>
                  <td class="px-4 py-3 text-emerald-600">Yes</td>
                  <td class="rounded-r-xl px-4 py-3 font-medium text-aerialPurple">Breakout</td>
                </tr>
                <tr class="bg-slate-100/70">
                  <td class="rounded-l-xl px-4 py-3 font-semibold text-slate-900">GOOGL</td>
                  <td class="px-4 py-3">$142.18</td>
                  <td class="px-4 py-3">19.2M</td>
                  <td class="px-4 py-3">$138.40</td>
                  <td class="px-4 py-3">$132.85</td>
                  <td class="px-4 py-3 text-emerald-600">58</td>
                  <td class="px-4 py-3">$145.50</td>
                  <td class="px-4 py-3">Mar 29</td>
                  <td class="px-4 py-3">No</td>
                  <td class="px-4 py-3">No</td>
                  <td class="px-4 py-3">Emerging</td>
                  <td class="px-4 py-3 text-amber-500">Watch</td>
                  <td class="rounded-r-xl px-4 py-3 font-medium text-aerialPurple">Trend</td>
                </tr>
                <tr class="bg-slate-100/70">
                  <td class="rounded-l-xl px-4 py-3 font-semibold text-slate-900">AMD</td>
                  <td class="px-4 py-3">$184.66</td>
                  <td class="px-4 py-3">17.3M</td>
                  <td class="px-4 py-3">$178.20</td>
                  <td class="px-4 py-3">$165.40</td>
                  <td class="px-4 py-3 text-emerald-600">65</td>
                  <td class="px-4 py-3">$192.80</td>
                  <td class="px-4 py-3">Apr 18</td>
                  <td class="px-4 py-3">Yes</td>
                  <td class="px-4 py-3">Yes</td>
                  <td class="px-4 py-3">Confirmed</td>
                  <td class="px-4 py-3 text-emerald-600">Yes</td>
                  <td class="rounded-r-xl px-4 py-3 font-medium text-aerialPurple">Momentum</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <script>
      const lastUpdatedElement = document.getElementById('last-updated');
      const tradingTableBody = document.getElementById('trading-table-body');
      const tradingEmptyState = document.getElementById('trading-empty-state');
      const tradingLoading = document.getElementById('trading-loading');
      const tradingError = document.getElementById('trading-error');
      const tickerFilter = document.getElementById('ticker-filter');
      const dateFilter = document.getElementById('date-filter');
      const clearFiltersButton = document.getElementById('clear-filters');
      const tradingDataUrl = 'data/idx-data.csv';

      let tradingData = [];

      const dateFormatter = new Intl.DateTimeFormat(undefined, {
        dateStyle: 'medium',
      });
      const priceFormatter = new Intl.NumberFormat('id-ID', {
        maximumFractionDigits: 0,
      });
      const numberFormatter = new Intl.NumberFormat('id-ID');
      let latestTradingDate = null;

      function determineLatestTradingDate() {
        latestTradingDate =
          tradingData
            .map((record) => record.date)
            .sort()
            .at(-1) ?? null;
      }

      function updateLastUpdated() {
        if (!lastUpdatedElement || tradingData.length === 0) {
          return;
        }
        determineLatestTradingDate();
        if (!latestTradingDate) {
          return;
        }
        lastUpdatedElement.textContent = dateFormatter.format(
          new Date(`${latestTradingDate}T00:00:00Z`),
        );
      }

      function populateFilters() {
        if (!tickerFilter || tradingData.length === 0) {
          return;
        }
        determineLatestTradingDate();

        const tickers = Array.from(new Set(tradingData.map((record) => record.symbol))).sort();
        tickerFilter.innerHTML = '<option value="all">All tickers</option>';
        tickers.forEach((symbol) => {
          const option = document.createElement('option');
          option.value = symbol;
          option.textContent = symbol;
          tickerFilter.append(option);
        });

        if (dateFilter) {
          const sortedDates = Array.from(new Set(tradingData.map((record) => record.date))).sort();
          if (sortedDates.length > 0) {
            dateFilter.min = sortedDates[0];
            dateFilter.max = sortedDates.at(-1);
          }
          if (latestTradingDate) {
            dateFilter.value = latestTradingDate;
          }
        }
      }

      function renderTable(rows) {
        if (!tradingTableBody) {
          return;
        }
        tradingTableBody.innerHTML = '';

        if (!rows || rows.length === 0) {
          if (tradingEmptyState) {
            tradingEmptyState.classList.remove('hidden');
          }
          return;
        }

        if (tradingEmptyState) {
          tradingEmptyState.classList.add('hidden');
        }

        rows.forEach((row) => {
          const tr = document.createElement('tr');
          tr.className = 'bg-slate-100/70';

          const cells = [
            row.symbol,
            row.open != null ? priceFormatter.format(row.open) : 'â€”',
            row.high != null ? priceFormatter.format(row.high) : 'â€”',
            row.close != null ? priceFormatter.format(row.close) : 'â€”',
            row.volume != null ? numberFormatter.format(row.volume) : 'â€”',
          ];

          cells.forEach((value, index) => {
            const td = document.createElement('td');
            td.className = `px-4 py-3 ${index === 0 ? 'rounded-l-xl font-semibold text-slate-900' : ''} ${
              index === cells.length - 1 ? 'rounded-r-xl' : ''
            }`;
            td.textContent = value;
            tr.append(td);
          });

          tradingTableBody.append(tr);
        });
      }

      function applyFilters() {
        if (tradingData.length === 0) {
          renderTable([]);
          return;
        }

        const selectedTicker = tickerFilter && tickerFilter.value !== 'all' ? tickerFilter.value : null;
        const selectedDate = dateFilter && dateFilter.value ? dateFilter.value : latestTradingDate;

        let filtered = tradingData.slice();
        if (selectedTicker) {
          filtered = filtered.filter((row) => row.symbol === selectedTicker);
        }
        if (selectedDate) {
          filtered = filtered.filter((row) => row.date === selectedDate);
        }

        filtered.sort((a, b) => {
          if (a.date === b.date) {
            return a.symbol.localeCompare(b.symbol);
          }
          return a.date < b.date ? 1 : -1;
        });

        renderTable(filtered);
      }

      async function loadTradingData() {
        if (!tradingTableBody) {
          return;
        }
        if (tradingLoading) {
          tradingLoading.classList.remove('hidden');
        }
        if (tradingError) {
          tradingError.classList.add('hidden');
          tradingError.textContent = '';
        }

        try {
          const response = await fetch(tradingDataUrl, { cache: 'no-cache' });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const text = await response.text();
          const lines = text
            .trim()
            .split(/\r?\n/)
            .filter((line) => line.trim().length > 0);

          if (lines.length <= 1) {
            tradingData = [];
          } else {
            const headers = lines[0].split(',').map((header) => header.trim());
            const tickerIndex = headers.indexOf('ticker');
            const dateIndex = headers.indexOf('date');
            const openIndex = headers.indexOf('open');
            const highIndex = headers.indexOf('high');
            const closeIndex = headers.indexOf('close');
            const volumeIndex = headers.indexOf('volume');

            const parseNumber = (value) => {
              if (value == null) {
                return null;
              }
              const trimmed = value.trim();
              if (trimmed === '') {
                return null;
              }
              const number = Number(trimmed);
              return Number.isFinite(number) ? number : null;
            };

            tradingData = lines
              .slice(1)
              .map((line) => line.split(','))
              .filter((columns) => columns.length === headers.length)
              .map((columns) => ({
                symbol: tickerIndex >= 0 ? columns[tickerIndex]?.trim() ?? '' : '',
                date: dateIndex >= 0 ? columns[dateIndex]?.trim() ?? '' : '',
                open: parseNumber(openIndex >= 0 ? columns[openIndex] : undefined),
                high: parseNumber(highIndex >= 0 ? columns[highIndex] : undefined),
                close: parseNumber(closeIndex >= 0 ? columns[closeIndex] : undefined),
                volume: parseNumber(volumeIndex >= 0 ? columns[volumeIndex] : undefined),
              }))
              .filter((row) => row.symbol && row.date);
          }
          determineLatestTradingDate();
          populateFilters();
          applyFilters();
          updateLastUpdated();
        } catch (error) {
          if (tradingError) {
            tradingError.textContent = `Failed to load trading data: ${error instanceof Error ? error.message : 'Unknown error'}`;
            tradingError.classList.remove('hidden');
          }
          renderTable([]);
          if (tradingEmptyState) {
            tradingEmptyState.classList.add('hidden');
          }
        } finally {
          if (tradingLoading) {
            tradingLoading.classList.add('hidden');
          }
        }
      }

      tickerFilter?.addEventListener('change', applyFilters);
      dateFilter?.addEventListener('change', applyFilters);
      clearFiltersButton?.addEventListener('click', (event) => {
        event.preventDefault();
        if (tickerFilter) {
          tickerFilter.value = 'all';
        }
        if (dateFilter) {
          dateFilter.value = latestTradingDate ?? '';
        }
        applyFilters();
      });

      document.querySelectorAll('.tab-button').forEach((button) => {
        button.addEventListener('click', () => {
          const selected = button.dataset.tab;

          document.querySelectorAll('.tab-button').forEach((btn) => {
            const isActive = btn.dataset.tab === selected;
            btn.classList.toggle('bg-aerialPurple', isActive);
            btn.classList.toggle('text-white', isActive);
            btn.classList.toggle('shadow-lg', isActive);
            btn.classList.toggle('shadow-aerialPurple/30', isActive);
            btn.classList.toggle('bg-slate-100', !isActive);
            btn.classList.toggle('text-aerialPurple', !isActive);
          });

          document.querySelectorAll('.tab-panel').forEach((panel) => {
            panel.classList.toggle('hidden', panel.dataset.panel !== selected);
          });
        });
      });

      loadTradingData();
    </script>
  </body>
</html>
